<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="profile.title">Perfil — RedVelvetLive</title>
  <meta name="description" content="Perfil público y preferencias de tu cuenta RedVelvetLive.">
  <link rel="canonical" href="https://www.redvelvetlive.com/profile.html">
  <meta name="color-scheme" content="dark light">

  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <!-- Header -->
  <div data-include="header"></div>

  <main class="main-container grid grid-2" style="--grid-min:300px">
    <!-- CARD: Perfil -->
    <section class="card" aria-labelledby="profileTitle">
      <div style="display:flex; gap:16px; align-items:center;">
        <div class="skeleton" id="avatarSk" style="width:64px;height:64px;border-radius:50%"></div>
        <img id="avatar" class="avatar" src="" alt="Avatar" style="display:none">
        <div>
          <h2 id="profileTitle" data-i18n="profile.title">—</h2>
          <div class="muted" id="tier">—</div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px; grid-template-columns:1fr; row-gap:6px;">
        <div><span data-i18n="profile.email">Email</span> — <span class="muted" id="email">—</span></div>
        <div><span data-i18n="profile.wallet">Wallet</span> — <span class="muted" id="walletShort">—</span></div>
        <div><span data-i18n="profile.status">Estado</span> — <span class="muted" id="status">—</span></div>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap">
        <a class="btn" href="/settings.html" data-i18n="profile.edit">Editar perfil</a>
        <a class="btn secondary" href="/wallet.html" data-i18n="profile.manageWallet">Conectar/gestionar wallet</a>
      </div>
    </section>

    <!-- CARD: Recompensas -->
    <section class="card" aria-labelledby="rewardsTitle">
      <h3 id="rewardsTitle" data-i18n="profile.rewards">Recompensas y logros</h3>
      <p class="muted" id="tierDesc">—</p>
      <a class="btn" href="/notifications.html" data-i18n="profile.viewRewards">Ver beneficios</a>
    </section>

    <!-- CARD: Saldo -->
    <section class="card" aria-labelledby="balanceTitle">
      <h3 id="balanceTitle" data-i18n="profile.balance">Saldo disponible</h3>
      <p class="muted">ONECOP: <strong id="balance">—</strong></p>
      <div class="grid grid-4" id="balanceGrid">
        <div class="skeleton" style="height:58px"></div>
        <div class="skeleton" style="height:58px"></div>
        <div class="skeleton" style="height:58px"></div>
        <div class="skeleton" style="height:58px"></div>
      </div>
    </section>

    <!-- CARD: Seguimientos -->
    <section class="card" aria-labelledby="followingTitle">
      <h3 id="followingTitle" data-i18n="profile.following">Modelos seguidas</h3>
      <div class="grid grid-4" id="followingGrid">
        <div class="skeleton" style="height:64px"></div>
        <div class="skeleton" style="height:64px"></div>
        <div class="skeleton" style="height:64px"></div>
        <div class="skeleton" style="height:64px"></div>
      </div>
    </section>
  </main>

  <!-- Footer + Cookies -->
  <div data-include="cookies"></div>
  <div data-include="footer"></div>

  <!-- Config -->
  <script>
    window.API_BASE  = window.API_BASE  || import.meta.env?.VITE_API_BASE  || '/api';
    window.AUTH_BASE = window.AUTH_BASE || import.meta.env?.VITE_AUTH_BASE || '/auth';
  </script>

  <!-- Scripts base -->
  <script src="/js/includes.js" defer></script>
  <script src="/js/navigation.js" defer></script>
  <script src="/js/i18n.js" defer></script>
  <script src="/js/analytics.js" defer></script>

  <!-- Script personalizado -->
  <script>
    (function(){
      const $  = (s,r=document)=>r.querySelector(s);
      const API = (p,opts={}) =>
        fetch((window.API_BASE||'/api')+p, Object.assign({credentials:'include'},opts))
          .then(async res=>{ if(!res.ok) throw new Error(await res.text()||('HTTP '+res.status)); try{return await res.json();}catch{return null;} });

      const elName   = $('#profileTitle');
      const elEmail  = $('#email');
      const elTier   = $('#tier');
      const elTierD  = $('#tierDesc');
      const elAvatar = $('#avatar');
      const elAvSk   = $('#avatarSk');
      const elStatus = $('#status');
      const elWShort = $('#walletShort');
      const elBal    = $('#balance');
      const balGrid  = $('#balanceGrid');
      const folGrid  = $('#followingGrid');

      function shortAddr(a){ return a && a.length>10 ? a.slice(0,6)+'…'+a.slice(-4) : (a||'—'); }
      function safeText(el, val){ if(el) el.textContent = (val ?? '—'); }
      function img(el, src){ if(!el) return; if(src){ el.src=src; el.style.display=''; } }

      function setFollowing(items){
        folGrid.innerHTML = '';
        if(!items || !items.length){
          folGrid.innerHTML = '<div class="muted" style="grid-column:1/-1" data-i18n="profile.noFollowing">No sigues a nadie aún.</div>';
          return;
        }
        items.slice(0,8).forEach(p=>{
          const card = document.createElement('div');
          card.className='card';
          card.style.display='flex';
          card.style.alignItems='center';
          card.style.gap='10px';
          card.innerHTML = `
            <img class="avatar" src="${p.avatar || '/assets/avatars/avatar-1.jpg'}" alt="${(p.name||p.handle||'Modelo')}" />
            <div>${p.name || p.handle || 'Modelo'}</div>
          `;
          folGrid.appendChild(card);
        });
      }

      function setBalance(bal){
        safeText(elBal, (typeof bal==='number' ? bal : (bal||'—')));
        balGrid.innerHTML = `
          <div class="card">Luna</div>
          <div class="card">Carmen</div>
          <div class="card">Marian</div>
          <div class="card">—</div>
        `;
      }

      async function hydrate(){
        try {
          const profile = await API('/users/profile').catch(()=>null);
          const name = profile?.displayName || profile?.username || 'Usuario';
          const email = profile?.email || '—';
          const tier  = profile?.tier  || profile?.rank || '—';
          const status= profile?.status || (profile ? 'Conectad@' : 'Invitado');
          const avatar= profile?.avatar || '/assets/avatars/avatar-1.jpg';

          safeText(elName, name);
          safeText(elEmail, email);
          safeText(elTier, tier);
          safeText(elTierD, tier && tier!=='—' ? `${tier} — progreso: 80%` : '—');
          safeText(elStatus, status);
          img(elAvatar, avatar); if (elAvSk) elAvSk.remove();

          const wallets = await API('/users/me/wallets').catch(()=>null);
          const primary = (Array.isArray(wallets)?wallets:wallets?.items||[]).find(w=>w.isPrimary) || (Array.isArray(wallets)?wallets[0]:null);
          safeText(elWShort, primary ? shortAddr(primary.address) : '—');

          const kpis = await API('/model/kpis').catch(()=>null);
          setBalance(kpis?.balanceOnecop ?? '—');

          const following = await API('/users/following').catch(()=>null);
          setFollowing(Array.isArray(following)?following:(following?.items||[]));
        } catch(e){
          console.warn('Profile fallback:', e);
          safeText(elName, 'Stivenson');
          safeText(elEmail, 'stivenson@example.com');
          safeText(elTier, 'Diamante');
          safeText(elTierD, 'Diamante — 80%');
          safeText(elStatus, 'Conectad@');
          img(elAvatar, '/assets/avatars/avatar-1.jpg'); if (elAvSk) elAvSk.remove();
          safeText(elWShort, shortAddr('0x7384...7397'));
          setBalance(212.6);
          setFollowing([{name:'Valeria'},{name:'Paula'},{name:'Sofía'}]);
        }
      }

      document.addEventListener('DOMContentLoaded', hydrate);
    })();
  </script>

  <style>
    .skeleton{position:relative;overflow:hidden;background:var(--panel-2);border-radius:12px}
    .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);animation:sh 1.1s infinite}
    @keyframes sh{to{transform:translateX(100%)}}
  </style>
</body>
</html>
